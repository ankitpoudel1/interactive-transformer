<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Transformer Self-Attention Visualization (USE-based)</title>
    <!-- Add TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
    <!-- Add TensorFlow Universal Sentence Encoder -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
        }
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            box-sizing: border-box;
        }
        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin: 0 0 20px 0;
            font-size: 24px;
        }
        h2 {
            font-size: 18px;
            margin: 0 0 15px 0;
            color: #34495e;
        }
        .playground-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            align-items: start;
            width: 100%;
        }
        @media (min-width: 1200px) {
            .playground-layout {
                grid-template-columns: 1fr;
            }
        }
        .matrix-container {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }
        .info-panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .input-container {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
            }
            .input-container input,
            .input-container button {
                width: 100%;
                margin: 0;
            }
            .input-container {
                padding: 10px 5px;
            }
            .matrix-container,
            .info-panel {
                padding: 8px;
                margin: 5px 0;
            }
            .sentence-display {
                padding: 8px;
                font-size: 14px;
            }
            .word-label, .cell {
                width: 60px;
                min-height: 25px;
                font-size: 11px;
                padding: 4px;
            }
        }
        .input-container input {
            width: calc(100% - 120px);
            margin-right: 10px;
            padding: 12px 16px;
            font-size: 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .input-container input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }
        .input-container button {
            width: 120px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-container button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            background: linear-gradient(135deg, #3498db, #2475a8);
        }
        .input-container button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .sentence-display {
            width: 100%;
            padding: 45px 15px 25px 15px; /* Increased top padding to make room for values */
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            line-height: 2.5;
            overflow-wrap: break-word;
            word-wrap: break-word;
            white-space: normal;
            position: relative;
            min-height: 150px; /* Increased for up/down arrows */
        }
        .legend {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        .legend ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .legend li {
            margin: 5px 0;
        }
        .attention-info {
            margin: 15px 0;
            padding: 12px;
            background-color: #fff3cd;
            border-radius: 6px;
            font-size: 14px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .explanation {
            font-size: 14px;
            line-height: 1.5;
            color: #666;
            margin: 10px 0;
        }
        .attention-matrix {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 5px;
            position: relative;
        }
        table {
            border-collapse: separate;
            border-spacing: 2px;
            margin: 0;
            min-width: max-content;
        }
        th, td {
            padding: 0;
            margin: 0;
        }
        .word-label {
            font-weight: bold;
            padding: 8px;
            background-color: #3498db;
            color: white;
            border-radius: 4px;
            width: 80px;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 12px;
            box-sizing: border-box;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            pointer-events: none;
            opacity: 1 !important; /* Make labels always visible */
        }
        .weight-label {
            pointer-events: none;
            opacity: 1 !important; /* Make labels always visible */
        }
        .weight-label text {
            font-weight: bold;
        }
        .weight-label rect {
            fill: white;
            stroke: rgba(52, 152, 219, 0.3);
            stroke-width: 1;
        }
        .cell {
            width: 80px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border-radius: 4px;
            transition: all 0.3s;
            cursor: pointer;
            color: white;
            box-sizing: border-box;
            position: relative;
        }
        .cell:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }
        .word-highlight {
            display: inline-block;
            padding: 3px 6px;
            margin: 2px;
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 2;
        }
        .word-highlight:hover {
            background-color: rgba(52, 152, 219, 0.2);
        }
        .word-highlight.source {
            background-color: rgba(231, 76, 60, 0.3);
            font-weight: bold;
        }
        .word-highlight.target {
            background-color: rgba(46, 204, 113, 0.3);
            font-weight: bold;
        }
        .word-highlight .word-score {
            position: absolute;
            top: -25px; /* Position score above the word */
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            background: white;
            padding: 2px 4px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .word-relationships {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            min-width: 200px;
            margin-top: 10px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .word-relationships.visible {
            display: block;
        }
        .relationship-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            margin: 4px 0;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .relationship-item:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        .relationship-score {
            margin-left: auto;
            font-weight: bold;
            color: #2c3e50;
            background: rgba(52, 152, 219, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-content {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .high-attention {
            background-color: rgba(52, 152, 219, 0.9) !important;
            font-weight: bold;
        }
        .medium-attention {
            background-color: rgba(52, 152, 219, 0.6) !important;
        }
        .low-attention {
            background-color: rgba(52, 152, 219, 0.2) !important;
            color: black;
        }
        .semantic-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #e9ecef;
        }
        .semantic-info h3 {
            font-size: 16px;
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        .semantic-pairs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            width: 100%;
        }
        .semantic-pair {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px;
            border-radius: 4px;
            background: #f8f9fa;
            margin-bottom: 4px;
        }
        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .model-info {
            background: #f1f8ff;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }
        .model-info h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 14px;
        }
        .model-info p {
            margin: 0;
            font-size: 13px;
            color: #34495e;
            line-height: 1.4;
        }
        .educational-section {
            width: 100%;
            max-width: 100%;
            overflow: hidden;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .educational-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        .concept-block {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .concept-block:last-child {
            margin-bottom: 0;
        }
        .concept-block h3 {
            color: #2c3e50;
            margin: 0 0 10px 0;
            font-size: 18px;
        }
        .concept-block p {
            color: #34495e;
            line-height: 1.6;
            margin: 0;
        }
        .implementation-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            width: 100%;
        }
        @media (max-width: 768px) {
            .implementation-details {
                grid-template-columns: 1fr;
            }
            .educational-section {
                padding: 15px;
            }
            .concept-block {
                padding: 12px;
            }
            h1 {
                font-size: 20px;
            }
            h2 {
                font-size: 16px;
            }
            h3 {
                font-size: 15px;
            }
            .semantic-pairs {
                grid-template-columns: 1fr;
            }
        }
        .detail-card {
            width: 100%;
            overflow: hidden;
        }
        .detail-card h4 {
            color: #2c3e50;
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        code {
            max-width: 100%;
            overflow-x: auto;
            display: block;
            padding: 8px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        @media (max-width: 768px) {
            .cell, .word-label, button {
                cursor: pointer;
                -webkit-tap-highlight-color: rgba(0,0,0,0);
            }
            .cell:hover {
                transform: none;
            }
            .weight-indicator {
                font-size: 10px;
                padding: 2px 4px;
            }
        }
        @media (max-width: 896px) and (orientation: landscape) {
            .container {
                max-height: 85vh;
                overflow-y: auto;
            }
            .playground-layout {
                grid-template-columns: 1fr;
            }
        }
        * {
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        @media (max-width: 768px) {
            input[type="text"] {
                font-size: 16px;
            }
        }
        /* Add a container for mobile view */
        .mobile-relationships-container {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            padding: 10px;
        }
        @media (max-width: 768px) {
            .word-relationships {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                transform: none;
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 12px 12px 0 0;
                max-height: 60vh;
                overflow-y: auto;
                background: white;
                z-index: 2001;
                padding: 16px;
                box-shadow: 0 -2px 20px rgba(0,0,0,0.2);
            }
            .word-highlight:hover .word-relationships {
                display: block;
            }
            /* Add close button for mobile */
            .word-relationships::before {
                content: '';
                display: block;
                width: 40px;
                height: 4px;
                background: #ccc;
                border-radius: 2px;
                margin: 0 auto 10px;
            }
            .relationship-item {
                padding: 8px;
                margin: 4px 0;
                border-bottom: 1px solid rgba(0,0,0,0.05);
            }
            .relationship-item:last-child {
                border-bottom: none;
            }
        }
        /* Prevent body scroll when popup is open on mobile */
        body.relationships-open {
            overflow: hidden;
        }
        /* Add backdrop for mobile */
        .relationships-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }
        @media (max-width: 768px) {
            .relationships-backdrop.active {
                display: block;
            }
        }
        .arrow-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .attention-arrow {
            position: absolute;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .attention-arrow.visible {
            opacity: 1;
        }
        .arrow-label {
            position: absolute;
            background: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            color: #2c3e50;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            pointer-events: none;
        }
        .attention-score {
            position: absolute;
            background: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
            color: #2c3e50;
            transform: translate(-50%, -50%);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            pointer-events: none;
        }
        .high-attention-arrow {
            stroke: rgba(52, 152, 219, 0.9);
            stroke-width: 2;
        }
        .medium-attention-arrow {
            stroke: rgba(52, 152, 219, 0.6);
            stroke-width: 1.5;
        }
        .low-attention-arrow {
            stroke: rgba(52, 152, 219, 0.3);
            stroke-width: 1;
        }
        .clear-arrows-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 3;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .clear-arrows-btn.visible {
            opacity: 1;
        }
        .clear-arrows-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        .arrow-container.persistent .attention-arrow {
            opacity: 0.9;
        }
        /* Add hover info for table cells */
        .cell-hover-info {
            position: absolute;
            background: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            pointer-events: none;
            font-size: 12px;
            color: #2c3e50;
            white-space: nowrap;
        }
        .cell:hover .cell-hover-info {
            display: block;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-content">
            <h2>Loading Model...</h2>
            <p>Please wait while the Universal Sentence Encoder is loading...</p>
        </div>
    </div>

    <div class="container">
        <h1>Interactive Transformer Self-Attention Visualization (USE-based)</h1>
        
        <div class="input-container">
            <div class="input-group">
                <input type="text" id="sentenceInput" placeholder="Enter a sentence..." value="Let's play a game us together">
                <button onclick="updateVisualization()" id="updateButton" disabled>Update</button>
            </div>
        </div>

        <div class="playground-layout">
            <div class="matrix-container">
                <div class="sentence-display" id="sentenceDisplay"></div>
                <div class="attention-matrix" id="attentionMatrix"></div>
            </div>
        </div>

        <div class="matrix-container">
            <div class="educational-section">
                <h2>Understanding Transformer Attention & Universal Sentence Encoder</h2>
                
                <div class="concept-block">
                    <h3>What is Attention?</h3>
                    <p>Attention is a mechanism that allows a model to focus on different parts of the input when producing each part of the output. 
                    In the context of language, it helps determine how much each word should "pay attention to" every other word in the sentence. 
                    This is crucial for understanding relationships between words and capturing the context of the sentence.</p>
                </div>

                <div class="concept-block">
                    <h3>Universal Sentence Encoder (USE)</h3>
                    <p>The Universal Sentence Encoder is a pre-trained model that converts text into high-dimensional vectors (embeddings). 
                    These embeddings capture semantic information about the text, meaning similar phrases will have similar embeddings. 
                    In this visualization, we use USE to generate embeddings for each word and calculate attention weights based on their similarity.</p>
                </div>

                <div class="concept-block">
                    <h3>How This Visualization Works</h3>
                    <p>When you enter a sentence, each word is processed through the Universal Sentence Encoder to get its embedding vector. 
                    The attention weights are then calculated using dot product similarity between these embeddings, normalized to values between 0 and 1. 
                    Darker blue colors indicate stronger attention (higher similarity) between words.</p>
                </div>
            </div>
        </div>

        <div class="matrix-container">
            <div class="educational-section">
                <h2>Implementation Details</h2>
                <div class="concept-block">
                    <h3>Embedding Generation</h3>
                    <p>Each word is embedded using TensorFlow.js and the Universal Sentence Encoder model, producing a 512-dimensional vector:</p>
                    <code>const embeddings = await model.embed(words);</code>
                </div>

                <div class="concept-block">
                    <h3>Attention Weight Calculation</h3>
                    <p>Attention weights are computed using dot product similarity between word embeddings, then normalized:</p>
                    <code>similarity = tf.dot(tensor_i, tensor_j);</code>
                </div>

                <div class="concept-block">
                    <h3>Visualization</h3>
                    <p>The attention matrix shows pairwise relationships between words. Each cell (i,j) represents how much word i attends to word j.
                    The weights are color-coded for easy interpretation.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let sentence = ["Let's", "play", "a", "game", "us", "together"]; // Default sentence
        let attentionWeights = []; // Will store the USE-based attention matrix
        let model = null;

        // Load Universal Sentence Encoder model
        async function loadModel() {
            try {
                model = await use.load();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('updateButton').disabled = false;
                updateVisualization(); // Initial visualization with default sentence
            } catch (error) {
                console.error('Error loading model:', error);
                document.getElementById('loading').innerHTML = 
                    '<div class="loading-content"><h2>Error Loading Model</h2><p>Failed to load the Universal Sentence Encoder. Please check your internet connection and refresh the page. See console for details.</p></div>';
            }
        }

        // Calculate attention weights using USE embeddings and dot product similarity
        async function calculateAttentionWeights(words) {
            if (!model || words.length === 0) return [];

            const embeddingsTensor = await model.embed(words);
            const embeddingsArray = await embeddingsTensor.array(); // JS array of embedding vectors
            tf.dispose(embeddingsTensor); // Dispose the main tensor once we have the JS array

            const numWords = words.length;
            const rawAttentionMatrix = [];

            for (let i = 0; i < numWords; i++) {
                rawAttentionMatrix[i] = [];
                for (let j = 0; j < numWords; j++) {
                    // Use tf.tidy to manage memory for intermediate tensors in dot product
                    const similarity = tf.tidy(() => {
                        const tensor_i = tf.tensor(embeddingsArray[i]);
                        const tensor_j = tf.tensor(embeddingsArray[j]);
                        return tf.dot(tensor_i, tensor_j).dataSync()[0];
                    });
                    rawAttentionMatrix[i][j] = similarity;
                }
            }

            // Normalize the raw attention matrix (dot products) to be between 0 and 1
            let minVal = Infinity;
            let maxVal = -Infinity;
            if (numWords > 0) {
                for (let i = 0; i < numWords; i++) {
                    for (let j = 0; j < numWords; j++) {
                        if (rawAttentionMatrix[i][j] < minVal) minVal = rawAttentionMatrix[i][j];
                        if (rawAttentionMatrix[i][j] > maxVal) maxVal = rawAttentionMatrix[i][j];
                    }
                }
            } else {
                return []; // No words, return empty matrix
            }
            

            const normalizedAttentionMatrix = [];
            const range = maxVal - minVal;

            for (let i = 0; i < numWords; i++) {
                normalizedAttentionMatrix[i] = [];
                for (let j = 0; j < numWords; j++) {
                    if (range > 1e-6) { // Avoid division by zero or tiny range
                        normalizedAttentionMatrix[i][j] = (rawAttentionMatrix[i][j] - minVal) / range;
                    } else { // If all values are the same (or very close)
                        normalizedAttentionMatrix[i][j] = 0.5; // Assign a neutral value
                    }
                }
            }
            return normalizedAttentionMatrix;
        }

        function createAttentionMatrix() {
            const matrixDiv = document.getElementById('attentionMatrix');
            matrixDiv.innerHTML = '';
            const table = document.createElement('table');
            
            // Create header row
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.appendChild(document.createElement('th'));
            sentence.forEach(word => {
                const th = document.createElement('th');
                const label = document.createElement('div');
                label.className = 'word-label';
                label.textContent = word;
                th.appendChild(label);
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            for(let i = 0; i < sentence.length; i++) {
                const row = document.createElement('tr');
                
                const th = document.createElement('th');
                const label = document.createElement('div');
                label.className = 'word-label';
                label.textContent = sentence[i];
                th.appendChild(label);
                row.appendChild(th);
                
                for(let j = 0; j < sentence.length; j++) {
                    const td = document.createElement('td');
                    const cell = document.createElement('div');
                    const weight = attentionWeights[i][j];
                    
                    cell.className = 'cell';
                    if (weight > 0.65) {
                        cell.classList.add('high-attention');
                    } else if (weight > 0.35) {
                        cell.classList.add('medium-attention');
                    } else {
                        cell.classList.add('low-attention');
                    }
                    
                    cell.textContent = weight.toFixed(2);
                    cell.setAttribute('data-from', i);
                    cell.setAttribute('data-to', j);
                    
                    cell.addEventListener('mouseenter', handleCellHover);
                    cell.addEventListener('mouseleave', handleCellLeave);
                    
                    td.appendChild(cell);
                    row.appendChild(td);
                }
                tbody.appendChild(row);
            }
            table.appendChild(tbody);
            matrixDiv.appendChild(table);
        }

        function handleCellHover(event) {
            const cell = event.currentTarget;
            const fromIdx = parseInt(cell.getAttribute('data-from'));
            const toIdx = parseInt(cell.getAttribute('data-to'));
            const weight = parseFloat(cell.textContent);

            // Highlight words in the sentence
            const words = document.querySelectorAll('.word-highlight');
            words.forEach(word => {
                word.classList.remove('source', 'target');
                word.querySelector('.word-score').textContent = '';
            });

            if (words[fromIdx]) {
                words[fromIdx].classList.add('source');
                words[fromIdx].querySelector('.word-score').textContent = ` →${weight.toFixed(2)}`;
            }
            if (words[toIdx]) {
                words[toIdx].classList.add('target');
                words[toIdx].querySelector('.word-score').textContent = ` ←${weight.toFixed(2)}`;
            }
        }

        function handleCellLeave() {
            // Clear highlighting
            const words = document.querySelectorAll('.word-highlight');
            words.forEach(word => {
                word.classList.remove('source', 'target');
                word.querySelector('.word-score').textContent = '';
            });
        }

        function displaySentence() {
            const display = document.getElementById('sentenceDisplay');
            if (sentence.length > 0) {
                display.innerHTML = sentence.map((word, idx) => `
                    <span class="word-highlight" 
                          data-word="${word}" 
                          data-index="${idx}"
                          onmouseenter="showWordArrows(event, false)"
                          onmouseleave="handleWordLeave(event)"
                          onclick="toggleWordArrows(event)">
                        ${word}
                        <span class="word-score"></span>
                    </span>
                `).join(' ');

                // Add clear arrows button
                const clearButton = document.createElement('button');
                clearButton.className = 'clear-arrows-btn';
                clearButton.textContent = 'Clear Arrows';
                clearButton.onclick = clearAllArrows;
                display.appendChild(clearButton);
            } else {
                display.innerHTML = "<em>No sentence entered.</em>";
            }
        }

        function showWordArrows(event, isPersistent = false) {
            const word = event.currentTarget;
            const wordIndex = parseInt(word.dataset.index);
            const wordRect = word.getBoundingClientRect();
            const sentenceDisplay = document.getElementById('sentenceDisplay');
            const displayRect = sentenceDisplay.getBoundingClientRect();

            // If not persistent and there's a persistent arrow container, don't show temporary arrows
            const existingContainer = sentenceDisplay.querySelector('.arrow-container');
            if (!isPersistent && existingContainer && existingContainer.classList.contains('persistent')) {
                return;
            }

            // Remove existing arrow container if it's not persistent or we're making new persistent arrows
            if (existingContainer && (!existingContainer.classList.contains('persistent') || isPersistent)) {
                existingContainer.remove();
            }

            // Create SVG container
            const arrowContainer = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            arrowContainer.classList.add('arrow-container');
            if (isPersistent) {
                arrowContainer.classList.add('persistent');
            }
            arrowContainer.style.position = 'absolute';
            arrowContainer.style.top = '0';
            arrowContainer.style.left = '0';
            arrowContainer.style.width = '100%';
            arrowContainer.style.height = '100%';

            // Show clear button if arrows are persistent
            const clearButton = sentenceDisplay.querySelector('.clear-arrows-btn');
            if (clearButton) {
                clearButton.classList.toggle('visible', isPersistent);
            }

            // Create arrows (existing arrow creation code remains the same)
            const words = sentenceDisplay.querySelectorAll('.word-highlight');
            words.forEach((targetWord, targetIndex) => {
                if (targetIndex !== wordIndex) {
                    const targetRect = targetWord.getBoundingClientRect();
                    const weight = attentionWeights[wordIndex][targetIndex];

                    // Calculate positions relative to sentence display
                    const x1 = wordRect.left - displayRect.left + wordRect.width/2;
                    const y1 = wordRect.top - displayRect.top + wordRect.height/2;
                    const x2 = targetRect.left - displayRect.left + targetRect.width/2;
                    const y2 = targetRect.top - displayRect.top + targetRect.height/2;

                    // Alternate between up and down based on target index and weight
                    const isUp = targetIndex % 2 === 0;
                    const arcHeight = isUp ? -30 - (weight * 20) : 30 + (weight * 20);

                    // Create arrow group
                    const arrow = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    arrow.classList.add('attention-arrow');

                    // Calculate control points for the curve
                    const cp1x = x1 + (x2 - x1) * 0.25;
                    const cp1y = y1 + arcHeight;
                    const cp2x = x1 + (x2 - x1) * 0.75;
                    const cp2y = y1 + arcHeight;

                    // Create the curved line
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    const d = `M ${x1},${y1} C ${cp1x},${cp1y} ${cp2x},${cp2y} ${x2},${y2}`;
                    line.setAttribute("d", d);
                    line.setAttribute("fill", "none");
                    line.setAttribute("stroke", `rgba(52, 152, 219, ${0.3 + weight * 0.6})`);
                    line.setAttribute("stroke-width", 1 + weight * 2);

                    // Calculate angle for arrowhead
                    const dx = x2 - cp2x;
                    const dy = y2 - cp2y;
                    const angle = Math.atan2(dy, dx);

                    // Create arrowhead
                    const arrowhead = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    const arrowLength = 8 + weight * 4;
                    const arrowWidth = 4 + weight * 2;
                    const arrowX = x2 - arrowLength * Math.cos(angle);
                    const arrowY = y2 - arrowLength * Math.sin(angle);
                    const arrowPath = `M ${x2},${y2} L ${arrowX - arrowWidth * Math.sin(angle)},${arrowY + arrowWidth * Math.cos(angle)} L ${arrowX + arrowWidth * Math.sin(angle)},${arrowY - arrowWidth * Math.cos(angle)} Z`;
                    arrowhead.setAttribute("d", arrowPath);
                    arrowhead.setAttribute("fill", `rgba(52, 152, 219, ${0.3 + weight * 0.6})`);

                    // Add label
                    const labelX = (cp1x + cp2x) / 2;
                    const labelY = y1 + arcHeight + (isUp ? -10 : 20);
                    const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    label.setAttribute("x", labelX);
                    label.setAttribute("y", labelY);
                    label.setAttribute("text-anchor", "middle");
                    label.setAttribute("fill", "#2c3e50");
                    label.setAttribute("font-size", "12");
                    label.textContent = weight.toFixed(2);

                    // Add white background for label
                    const labelBg = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    const padding = 4;
                    const bbox = { width: 30, height: 15 };
                    labelBg.setAttribute("x", labelX - bbox.width/2 - padding);
                    labelBg.setAttribute("y", labelY - bbox.height + 2);
                    labelBg.setAttribute("width", bbox.width + padding * 2);
                    labelBg.setAttribute("height", bbox.height + padding);
                    labelBg.setAttribute("fill", "white");
                    labelBg.setAttribute("rx", "3");

                    arrow.appendChild(line);
                    arrow.appendChild(arrowhead);
                    arrow.appendChild(labelBg);
                    arrow.appendChild(label);
                    arrowContainer.appendChild(arrow);
                }
            });

            sentenceDisplay.appendChild(arrowContainer);

            // Make arrows visible with a slight delay for animation
            setTimeout(() => {
                arrowContainer.querySelectorAll('.attention-arrow').forEach(arrow => {
                    arrow.classList.add('visible');
                });
            }, 50);
        }

        function handleWordLeave(event) {
            const sentenceDisplay = document.getElementById('sentenceDisplay');
            const arrowContainer = sentenceDisplay.querySelector('.arrow-container');
            if (arrowContainer && !arrowContainer.classList.contains('persistent')) {
                hideWordArrows();
            }
        }

        function toggleWordArrows(event) {
            const sentenceDisplay = document.getElementById('sentenceDisplay');
            const existingContainer = sentenceDisplay.querySelector('.arrow-container');
            
            if (existingContainer && existingContainer.classList.contains('persistent')) {
                clearAllArrows();
            } else {
                showWordArrows(event, true);
            }
        }

        function clearAllArrows() {
            const sentenceDisplay = document.getElementById('sentenceDisplay');
            const arrowContainer = sentenceDisplay.querySelector('.arrow-container');
            if (arrowContainer) {
                arrowContainer.querySelectorAll('.attention-arrow').forEach(arrow => {
                    arrow.classList.remove('visible');
                });
                setTimeout(() => arrowContainer.remove(), 300);
            }
            
            // Hide clear button
            const clearButton = sentenceDisplay.querySelector('.clear-arrows-btn');
            if (clearButton) {
                clearButton.classList.remove('visible');
            }
        }

        function hideWordArrows() {
            const arrowContainer = document.querySelector('.arrow-container');
            if (arrowContainer && !arrowContainer.classList.contains('persistent')) {
                arrowContainer.querySelectorAll('.attention-arrow').forEach(arrow => {
                    arrow.classList.remove('visible');
                });
                setTimeout(() => arrowContainer.remove(), 300);
            }
        }

        async function updateVisualization() {
            if (!model) {
                document.getElementById('loading').innerHTML = 
                    '<div class="loading-content"><h2>Error</h2><p>Model not loaded. Cannot update.</p></div>';
                document.getElementById('loading').style.display = 'flex';
                return;
            }

            const loadingDiv = document.getElementById('loading');
            loadingDiv.style.display = 'flex';
            loadingDiv.innerHTML = 
                '<div class="loading-content"><h2>Calculating...</h2><p>Fetching embeddings and computing attention scores...</p></div>';
            
            document.getElementById('updateButton').disabled = true;

            try {
                const input = document.getElementById('sentenceInput').value;
                sentence = input.trim().split(/\s+/).filter(w => w.length > 0);
                
                if (sentence.length === 0) {
                    document.getElementById('attentionMatrix').innerHTML = '<p style="text-align:center;">Please enter a sentence.</p>';
                    displaySentence();
                    loadingDiv.style.display = 'none';
                    document.getElementById('updateButton').disabled = false;
                    return;
                }
                
                attentionWeights = await calculateAttentionWeights(sentence);
                document.getElementById('attentionMatrix').innerHTML = '';
                displaySentence();
                createAttentionMatrix();

                loadingDiv.style.display = 'none';
            } catch (error) {
                console.error('Error updating visualization:', error);
                loadingDiv.innerHTML = 
                    '<div class="loading-content"><h2>Error</h2><p>Failed to calculate attention weights. Please check the console for details.</p></div>';
            } finally {
                document.getElementById('updateButton').disabled = false;
            }
        }

        // Initialize by loading the model
        loadModel();
    </script>
</body>
</html>
